name: Build and Release LaTeX PDF

# 触发策略：push/PR 到默认分支会构建；push tag 会触发 release job（见 jobs.release 的条件）
on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'    # 以 v 开头的 tag 会触发 release（可根据需要调整）
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  packages: write
  issues: write

jobs:
  build:
    name: Build PDF
    runs-on: ubuntu-latest
    outputs:
      pdf-file: ${{ steps.set_pdf.outputs.pdf_file }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Ensure script exists
        run: |
          if [ ! -x "./print_used_latex_packages.py" ] && [ -f "./print_used_latex_packages.py" ]; then
            chmod +x ./print_used_latex_packages.py || true
          fi

      - name: Extract LaTeX packages from math.tex
        id: extract_pkgs
        run: |
          set -euo pipefail
          TEX_MAIN=math.tex
          if [ ! -f "$TEX_MAIN" ]; then
            echo "ERROR: $TEX_MAIN not found"
            exit 1
          fi

          # Run the python script; it should output comma-separated package names (or empty)
          PKG_CSV=$(python3 ./print_used_latex_packages.py "$TEX_MAIN" || true)
          # Trim whitespace
          PKG_CSV=$(echo "$PKG_CSV" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          echo "packages_csv=$PKG_CSV" >> "$GITHUB_OUTPUT"

      - name: Try install packages via tlmgr (fallback to apt if needed)
        run: |
          set -euo pipefail
          PKG_CSV="${{ steps.extract_pkgs.outputs.packages_csv }}"
          echo "Packages CSV: '$PKG_CSV'"

          # If no packages found, skip install step
          if [ -z "$PKG_CSV" ]; then
            echo "No packages reported by script; skipping package install step."
            exit 0
          fi

          # Convert CSV to array
          read -r -a PKGS <<< "$(echo "$PKG_CSV" | tr ',' ' ')"
          echo "Will attempt to install: ${PKGS[*]}"

          if command -v tlmgr >/dev/null 2>&1; then
            echo "tlmgr found. Attempting tlmgr install for each package (non-fatal on failure)."
            # try self-update (non-fatal)
            sudo tlmgr update --self || true
            sudo tlmgr install ctex
            for pkg in "${PKGS[@]}"; do
              if [ -z "$pkg" ]; then
                continue
              fi
              echo "Attempting: sudo tlmgr install $pkg"
              sudo tlmgr install "$pkg" || echo "tlmgr install $pkg failed, continuing"
            done
            echo "tlmgr install attempts finished."
          else
            echo "tlmgr not found. Installing common texlive collections via apt as fallback."
            sudo apt-get update -qq
            sudo apt-get install -y --no-install-recommends texlive-base
            sudo apt-get install -y --no-install-recommends latexmk                 # essential for 'latexmk'
            sudo apt-get install -y --no-install-recommends texlive-xetex           # essential for 'xelatex'
            sudo apt-get install -y --no-install-recommends biber                   # essential for 'biber'
            sudo apt-get install -y --no-install-recommends texlive-lang-chinese    # essential for 'ctexbook.cls'
            sudo apt-get install -y --no-install-recommends \
              texlive-latex-base texlive-latex-extra texlive-latex-recommended \
              texlive-bibtex-extra texlive-pictures texlive-plain-generic \
              texlive-science texlive-fonts-recommended texlive-fonts-extra

            # 先用 find 命令在 /usr/share/texlive 中查找 *.sty 文件，收集无法定位到路径的 *.sty 文件，形成一个列表 `PKGS_NOT_FOUND`
            if [ -d /usr/share/texlive ]; then
              PKGS_NOT_FOUND=()
              for pkg in "${PKGS[@]}"; do
                if [ -z "$pkg" ]; then
                  continue
                fi
                # Try to find the sty file under /usr/share/texlive (case-insensitive)
                foundpath=$(find /usr/share/texlive -type f -iname "${pkg}.sty" 2>/dev/null | head -n 1 || true)
                if [ -n "$foundpath" ]; then
                  echo "LaTeX style package '${pkg}.sty' found at: $foundpath"
                else
                  echo "LaTeX style package '${pkg}.sty' not found under /usr/share/texlive -> adding to PKGS_NOT_FOUND"
                  PKGS_NOT_FOUND+=("$pkg")
                fi
              done
              echo "PKGS_NOT_FOUND: ${PKGS_NOT_FOUND[*]:-<empty>}"
            else
              echo "Directory '/usr/share/texlive' not found"
              exit 1
            fi

            # 如果列表 `PKGS_NOT_FOUND` 非空，则安装 apt-file 再依据 `PKGS_NOT_FOUND`（而不是 `PKGS`）生成列表 `APT_PKGS`
            if [ "${#PKGS_NOT_FOUND[@]}" -gt 0 ]; then
              sudo apt-get install -y --no-install-recommends apt-file
              sudo apt-file update
              # Install packages
              APT_PKGS=()
              for pkg in "${PKGS_NOT_FOUND[@]}"; do
                if [ -z "$pkg" ]; then
                  continue
                fi
                echo "Searching apt-file for /${pkg}.sty"
                # collect package names that provide paths under /usr/share/texlive
                mapfile -t found < <(apt-file search "/${pkg}.sty" | awk -F: '/\/usr\/share\/texlive/ {print $1}')
                if [ "${#found[@]}" -gt 0 ]; then
                  for f in "${found[@]}"; do
                    APT_PKGS+=("$f")
                  done
                else
                  echo "No apt-file results for /${pkg}.sty"
                fi
              done
              # 用 echo 打印列表 `APT_PKGS` 的内容
              if [ "${#APT_PKGS[@]}" -eq 0 ]; then
                echo "APT_PKGS is empty: no matching apt packages found for any LaTeX package"
                APT_PKGS_UNIQ=()
              else
                # deduplicate
                mapfile -t APT_PKGS_UNIQ < <(printf "%s\n" "${APT_PKGS[@]}" | sort -u)
                echo "APT packages to install: ${APT_PKGS_UNIQ[*]}"
                sudo apt-get install -y --no-install-recommends "${APT_PKGS_UNIQ[@]}"
              fi
            else
              echo "No PKGS_NOT_FOUND; skipping apt-file search."
            fi
            echo "Apt fallback installation finished."
          fi

      - name: Build with latexmk (xelatex)
        id: build_pdf
        env:
          TEX_MAIN: math.tex
        run: |
          set -euo pipefail
          TEX_MAIN="${TEX_MAIN:-math.tex}"
          if [ ! -f "$TEX_MAIN" ]; then
            echo "ERROR: main tex file '$TEX_MAIN' not found"
            exit 1
          fi

          # Clean previous runs to avoid stale artifacts
          latexmk -C -silent || true

          xelatex -interaction=nonstopmode -file-line-error math.tex

          # run biber if .bcf exists
          if [ -f math.bcf ]; then
            biber math
          else
            echo "ERROR: expected bcf (math.bcf) not found after latexmk"
            exit 1
          fi

          # Run latexmk with xelatex engine; fail on error
          latexmk -xelatex -interaction=nonstopmode -file-line-error "$TEX_MAIN"

          # Determine generated PDF name
          PDF_FILE="$(basename "$TEX_MAIN" .tex).pdf"
          if [ ! -f "$PDF_FILE" ]; then
            echo "ERROR: expected PDF ($PDF_FILE) not found after latexmk"
            exit 1
          fi
          echo "Built PDF: $PDF_FILE"
          # Expose PDF filename for later jobs
          echo "pdf_file=$PDF_FILE" >> "$GITHUB_OUTPUT"

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-pdf
          path: |
            *.pdf

      - name: Set output for downstream jobs
        id: set_pdf
        run: |
          # ensure output is set (redundant if build_pdf set it)
          PDF_FILE="${{ steps.build_pdf.outputs.pdf_file }}"
          if [ -z "$PDF_FILE" ]; then
            PDF_FILE="$(basename math.tex .tex).pdf"
          fi
          echo "::set-output name=pdf_file::$PDF_FILE"

  release:
    name: Create GitHub Release (attach PDF)
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download built PDF artifact
        uses: actions/download-artifact@v4
        with:
          name: compiled-pdf
          path: ./artifact

      - name: List artifact contents
        run: |
          echo "Files in artifact directory:"
          ls -la ./artifact || true

      - name: Create GitHub Release and upload PDF
        id: gh_release
        uses: softprops/action-gh-release@v2
        with:
          files: ./artifact/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show release URL
        run: |
          echo "Release created. You can view it at: https://github.com/${{ github.repository }}/releases/tag/${GITHUB_REF##*/}"
