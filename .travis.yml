# .travis.yml
language: r
sudo: required
dist: trusty

# 缓存加速重复构建
cache:
  packages: true

env:
  # 可配置主 tex 文件名
  - TEX_MAIN=math.tex

before_install:
  # 安装或确认 latexmk（用于后续编译）
  - |
    if command -v latexmk >/dev/null 2>&1; then
      echo "latexmk found: $(latexmk --version | head -n 1)"
    else
      echo "latexmk not found — installing via apt"
      sudo apt-get -qq update
      sudo apt-get -yqq --no-install-recommends install latexmk texlive-xetex
    fi

  # 使用仓库中的脚本提取 main_tex 中的 \usepackage 包名，并逐个尝试 tlmgr install
  # 如果 tlmgr 不存在或不可用，则退回安装常用 texlive 包作为兜底（texlive-latex-extra / texlive-fonts-recommended）
  - |
    set -e
    echo "Extracting LaTeX packages from $TEX_MAIN using $PY"
    if [ ! -f "$TEX_MAIN" ]; then
      echo "ERROR: TEX main file '$TEX_MAIN' not found"
      exit 1
    fi

    # 调用脚本，得到以逗号分隔的包名（print_used_latex_packages.py 应位于仓库根）
    PACKAGES_CSV=$($PY print_used_latex_packages.py "$TEX_MAIN" || true)
    echo "Packages extracted (csv): '$PACKAGES_CSV'"

    # 如果没有提取到包则略过
    if [ -z "$PACKAGES_CSV" ]; then
      echo "No packages to install via tlmgr."
    else
      # 将逗号分隔转换为空格分隔，方便循环
      # 也把可能的空项剔除
      PACKAGES=$(echo "$PACKAGES_CSV" | tr ',' ' ' | xargs -n1 | sed '/^\s*$/d' | xargs)
      echo "Packages to try install: $PACKAGES"

      # 如果 tlmgr 可用，优先用 tlmgr 安装（尝试 update --self 以防需要）
      if command -v tlmgr >/dev/null 2>&1; then
        echo "tlmgr found, trying tlmgr install for each package..."
        # 有时 tlmgr 需要先 self-update（非强制）
        tlmgr --version || true
        sudo tlmgr update --self || true
        for pkg in $PACKAGES; do
          echo "Attempting tlmgr install $pkg"
          # 允许单个包失败，但继续尝试其它包
          sudo tlmgr install "$pkg" || {
            echo "tlmgr install $pkg failed; continuing (will try apt fallback later if needed)"
          }
        done
      else
        echo "tlmgr not found. Will attempt apt fallback installs."
        # apt fallback: 安装一组常见 texlive 包（尽量覆盖常见宏包）
        sudo apt-get -qq update
        sudo apt-get -yqq --no-install-recommends install \
          texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended \
          texlive-xetex || true
      fi
    fi

script:
  # 使用 latexmk 自动化构建，指定 xelatex 引擎，并在出错时停止（-halt-on-error 并通过 -interaction 控制）
  - latexmk -interaction=nonstopmode -file-line-error -xelatex "$TEX_MAIN"

before_deploy:
  - ls -la
  - echo "Preparing to deploy: ensure PDF exists"
  - export PDF_FILE="$(basename "$TEX_MAIN" .tex).pdf"
  - if [ ! -f "$PDF_FILE" ]; then echo "ERROR: $PDF_FILE not found"; exit 1; fi
  - git config --local user.name "deploy-bot (from Travis CI)"
  - git config --local user.email "deploy@travis-ci.org"
  - export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
  - git tag "TravisRelease-$TRAVIS_TAG"

deploy:
  provider: releases
  api_key: "$GITHUB_TOKEN"
  file: "$PDF_FILE"
  file_glob: false
  skip_cleanup: true
  on:
    tags: true

notifications:
  email: false
